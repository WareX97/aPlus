\hypertarget{unlink_8c}{\section{src/syscall/unlink.c File Reference}
\label{unlink_8c}\index{src/syscall/unlink.\+c@{src/syscall/unlink.\+c}}
}
{\ttfamily \#include $<$aplus.\+h$>$}\\*
{\ttfamily \#include $<$aplus/syscall.\+h$>$}\\*
{\ttfamily \#include $<$aplus/fs.\+h$>$}\\*
{\ttfamily \#include $<$aplus/task.\+h$>$}\\*
{\ttfamily \#include $<$unistd.\+h$>$}\\*
{\ttfamily \#include $<$fcntl.\+h$>$}\\*
{\ttfamily \#include $<$errno.\+h$>$}\\*
{\ttfamily \#include $<$sys/stat.\+h$>$}\\*
{\ttfamily \#include $<$dirent.\+h$>$}\\*
{\ttfamily \#include $<$stdio.\+h$>$}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
static char $\ast$ \hyperlink{unlink_8c_a6fae53653306206ed481c3589c7aa51b}{dupstr} (char $\ast$s)
\item 
int \hyperlink{unlink_8c_a1f6398df52f7ff1425ea46d566e6d406}{sys\+\_\+unlink} (const char $\ast$pathname)
\item 
\hyperlink{unlink_8c_ad98c9664626206607298e17936a4421e}{S\+Y\+S\+C\+A\+L\+L} (\hyperlink{unlink_8c_a1f6398df52f7ff1425ea46d566e6d406}{sys\+\_\+unlink}, 15)
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{task_8h_a8aeef2cdb643462b97cd459a8e68cad3}{task\+\_\+t} $\ast$ \hyperlink{unlink_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\+\_\+task}
\begin{DoxyCompactList}\small\item\em Current task address. \end{DoxyCompactList}\item 
\hyperlink{fs_8h_a48b686d0c4375b0d1aab2296dc36c7a6}{inode\+\_\+t} $\ast$ \hyperlink{unlink_8c_a9af8258c3554800f6613f8147544225f}{vfs\+\_\+root}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{unlink_8c_a6fae53653306206ed481c3589c7aa51b}{\index{unlink.\+c@{unlink.\+c}!dupstr@{dupstr}}
\index{dupstr@{dupstr}!unlink.\+c@{unlink.\+c}}
\subsubsection[{dupstr}]{\setlength{\rightskip}{0pt plus 5cm}static char$\ast$ dupstr (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{s}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{unlink_8c_a6fae53653306206ed481c3589c7aa51b}


Definition at line 18 of file unlink.\+c.



References kmalloc().


\begin{DoxyCode}
18                              \{
19     \textcolor{keywordtype}{char}* p = (\textcolor{keywordtype}{char}*) \hyperlink{mm_8h_a1f5d4240b2decc62c0e6eae06c72916c}{kmalloc}(strlen(s) + 1);
20     strcpy(p, s);
21 
22     \textcolor{keywordflow}{return} p;
23 \}
\end{DoxyCode}
\hypertarget{unlink_8c_a1f6398df52f7ff1425ea46d566e6d406}{\index{unlink.\+c@{unlink.\+c}!sys\+\_\+unlink@{sys\+\_\+unlink}}
\index{sys\+\_\+unlink@{sys\+\_\+unlink}!unlink.\+c@{unlink.\+c}}
\subsubsection[{sys\+\_\+unlink}]{\setlength{\rightskip}{0pt plus 5cm}int sys\+\_\+unlink (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{pathname}
\end{DoxyParamCaption}
)}}\label{unlink_8c_a1f6398df52f7ff1425ea46d566e6d406}


Definition at line 26 of file unlink.\+c.



References task\+::cwd, dupstr(), errno, fs\+\_\+finddir(), fs\+\_\+unlink(), kfree(), kprintf(), inode\+::link, inode\+::mode, and vfs\+\_\+root.


\begin{DoxyCode}
26                                      \{
27     \textcolor{keywordflow}{if}(!pathname) \{
28         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = EINVAL;
29         \textcolor{keywordflow}{return} -1;
30     \}
31 
32 
33     \hyperlink{structinode}{inode\_t}* cwd = NULL;
34 
35     \textcolor{keywordflow}{if}(pathname[0] == \textcolor{charliteral}{'/'})
36         cwd = \hyperlink{unlink_8c_a9af8258c3554800f6613f8147544225f}{vfs\_root};
37     \textcolor{keywordflow}{else}
38         cwd = \hyperlink{unlink_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\_task}->\hyperlink{structtask_a7099e7ba6a4c94559edfb4d396803b15}{cwd};
39     
40     \textcolor{keywordflow}{if}(!cwd) \{
41         \textcolor{keywordflow}{if}(!\hyperlink{unlink_8c_a9af8258c3554800f6613f8147544225f}{vfs\_root}) \{
42             \hyperlink{debug_8c_ac9d768b4772cc87fc88afbbbd805f96a}{kprintf}(\textcolor{stringliteral}{"sys\_unlink: no root found for cwd."});
43         
44             \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
45             \textcolor{keywordflow}{return} -1;
46         \}
47         
48         cwd = \hyperlink{unlink_8c_a9af8258c3554800f6613f8147544225f}{vfs\_root};
49     \}
50     
51     
52     \textcolor{keywordflow}{if}(pathname[0] == \textcolor{charliteral}{'/'})
53         pathname++;
54         
55     \textcolor{keywordflow}{if}(pathname[0] == 0) \{
56         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = EPERM; 
57         \textcolor{keywordflow}{return} -1;
58     \}
59     
60     \textcolor{keywordtype}{char}* b = \hyperlink{unlink_8c_a6fae53653306206ed481c3589c7aa51b}{dupstr}((\textcolor{keywordtype}{char}*) pathname);
61     \textcolor{keywordtype}{char}* s = b;
62     \textcolor{keywordtype}{char}* p = s;
63     
64     \textcolor{keywordflow}{while}(*s) \{
65         \textcolor{keywordflow}{if}((p = strchr(s, \textcolor{charliteral}{'/'}))) \{
66             *p++ = 0;
67         
68             cwd = (\hyperlink{structinode}{inode\_t}*) \hyperlink{fs_8c_ad8edcff785980ccbc26c887c19ac8989}{fs\_finddir}(cwd, s);
69             \textcolor{keywordflow}{if}(!cwd) \{
70                 \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
71                 \textcolor{keywordflow}{return} -1;
72             \}
73 
74             \textcolor{keywordflow}{while}(S\_ISLNK(cwd->\hyperlink{structinode_a4902d9f6a1d7bd79c6f1bb73d83ce8e3}{mode}))
75                 \textcolor{keywordflow}{if}(cwd->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link})
76                     cwd = cwd->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link};
77                 \textcolor{keywordflow}{else}
78                     \textcolor{keywordflow}{break};
79 
80             s = p;
81         \} \textcolor{keywordflow}{else}
82             \textcolor{keywordflow}{break};
83     \}
84 
85     \textcolor{keywordflow}{if}(*s == 0) \{
86         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
87         \textcolor{keywordflow}{return} -1;
88     \}
89 
90     \textcolor{keywordtype}{int} ret = \hyperlink{fs_8c_ab0e4dd01b14f5ba2495318b840acdfff}{fs\_unlink}(cwd, s);
91     \hyperlink{mm_8h_acee1960bdb3a19cb495341ec725cafef}{kfree}(b);
92     
93     \textcolor{keywordflow}{return} ret;
94 \}
\end{DoxyCode}
\hypertarget{unlink_8c_ad98c9664626206607298e17936a4421e}{\index{unlink.\+c@{unlink.\+c}!S\+Y\+S\+C\+A\+L\+L@{S\+Y\+S\+C\+A\+L\+L}}
\index{S\+Y\+S\+C\+A\+L\+L@{S\+Y\+S\+C\+A\+L\+L}!unlink.\+c@{unlink.\+c}}
\subsubsection[{S\+Y\+S\+C\+A\+L\+L}]{\setlength{\rightskip}{0pt plus 5cm}S\+Y\+S\+C\+A\+L\+L (
\begin{DoxyParamCaption}
\item[{{\bf sys\+\_\+unlink}}]{, }
\item[{15}]{}
\end{DoxyParamCaption}
)}}\label{unlink_8c_ad98c9664626206607298e17936a4421e}


\subsection{Variable Documentation}
\hypertarget{unlink_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{\index{unlink.\+c@{unlink.\+c}!current\+\_\+task@{current\+\_\+task}}
\index{current\+\_\+task@{current\+\_\+task}!unlink.\+c@{unlink.\+c}}
\subsubsection[{current\+\_\+task}]{\setlength{\rightskip}{0pt plus 5cm}{\bf task\+\_\+t}$\ast$ current\+\_\+task}}\label{unlink_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}


Current task address. 



Definition at line 37 of file sched.\+c.

\hypertarget{unlink_8c_a9af8258c3554800f6613f8147544225f}{\index{unlink.\+c@{unlink.\+c}!vfs\+\_\+root@{vfs\+\_\+root}}
\index{vfs\+\_\+root@{vfs\+\_\+root}!unlink.\+c@{unlink.\+c}}
\subsubsection[{vfs\+\_\+root}]{\setlength{\rightskip}{0pt plus 5cm}{\bf inode\+\_\+t}$\ast$ vfs\+\_\+root}}\label{unlink_8c_a9af8258c3554800f6613f8147544225f}


Definition at line 19 of file vfs.\+c.

