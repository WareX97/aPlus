\hypertarget{mount_8c}{\section{src/syscall/mount.c File Reference}
\label{mount_8c}\index{src/syscall/mount.\+c@{src/syscall/mount.\+c}}
}
{\ttfamily \#include $<$aplus.\+h$>$}\\*
{\ttfamily \#include $<$aplus/fs.\+h$>$}\\*
{\ttfamily \#include $<$aplus/task.\+h$>$}\\*
{\ttfamily \#include $<$aplus/list.\+h$>$}\\*
{\ttfamily \#include $<$aplus/attribute.\+h$>$}\\*
{\ttfamily \#include $<$aplus/syscall.\+h$>$}\\*
{\ttfamily \#include $<$aplus/fsys.\+h$>$}\\*
{\ttfamily \#include $<$stdint.\+h$>$}\\*
{\ttfamily \#include $<$unistd.\+h$>$}\\*
{\ttfamily \#include $<$dirent.\+h$>$}\\*
{\ttfamily \#include $<$fcntl.\+h$>$}\\*
{\ttfamily \#include $<$sys/types.\+h$>$}\\*
{\ttfamily \#include $<$errno.\+h$>$}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{mount_8c_adbb2f2f41fa719d188b9291a25afdd98}{sys\+\_\+mount} (const char $\ast$dev, const char $\ast$dir, const char $\ast$fstype, int options, const void $\ast$\hyperlink{iso9660_8h_ae308b441db3cd9ff9e80e01730229e3b}{data})
\item 
\hyperlink{mount_8c_ad1f2426abc49e3a353545a7f6fd465eb}{S\+Y\+S\+C\+A\+L\+L} (\hyperlink{mount_8c_adbb2f2f41fa719d188b9291a25afdd98}{sys\+\_\+mount}, 24)
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{task_8h_a8aeef2cdb643462b97cd459a8e68cad3}{task\+\_\+t} $\ast$ \hyperlink{mount_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\+\_\+task}
\begin{DoxyCompactList}\small\item\em Current task address. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{mount_8c_adbb2f2f41fa719d188b9291a25afdd98}{\index{mount.\+c@{mount.\+c}!sys\+\_\+mount@{sys\+\_\+mount}}
\index{sys\+\_\+mount@{sys\+\_\+mount}!mount.\+c@{mount.\+c}}
\subsubsection[{sys\+\_\+mount}]{\setlength{\rightskip}{0pt plus 5cm}int sys\+\_\+mount (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{dev, }
\item[{const char $\ast$}]{dir, }
\item[{const char $\ast$}]{fstype, }
\item[{int}]{options, }
\item[{const void $\ast$}]{data}
\end{DoxyParamCaption}
)}}\label{mount_8c_adbb2f2f41fa719d188b9291a25afdd98}


Definition at line 22 of file mount.\+c.



References attribute(), inode\+::dev, errno, task\+::fd, fs, im\+\_\+superuser(), inode\+::ino, list\+\_\+destroy, list\+\_\+empty(), list\+\_\+foreach, inode\+::mode, fsys\+::mount, fsys\+::name, O\+\_\+\+D\+I\+R\+E\+C\+T\+O\+R\+Y, sys\+\_\+close(), sys\+\_\+open(), and value.


\begin{DoxyCode}
22                                                                                                    \{
23     \textcolor{keywordflow}{if}(!\hyperlink{mount_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\_task})
24         \textcolor{keywordflow}{return} -1;
25 
26 
27     \textcolor{keywordflow}{if}(!\hyperlink{src_2sched_8c_a11eb67cd27beaf272f76796f65d1ca1c}{im\_superuser}()) \{
28         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = EPERM;
29         \textcolor{keywordflow}{return} -1;
30     \}
31 
32 
33     \textcolor{keywordflow}{if}(dir == NULL || strlen(dir) == 0) \{
34         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = EINVAL;
35         \textcolor{keywordflow}{return} -1;
36     \}
37 
38     \hyperlink{structinode}{inode\_t}* idev = NULL;
39     \hyperlink{structinode}{inode\_t}* idir = NULL;
40 
41 
42     \textcolor{keywordflow}{if}(dev && strlen(dev) > 0) \{
43         \textcolor{keywordtype}{int} dfd = \hyperlink{open_8c_ab7835c4352479c7a3d7af78c138e81c1}{sys\_open}(dev, O\_RDONLY, 0644);
44         \textcolor{keywordflow}{if}(dfd < 0) \{
45             \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
46             \textcolor{keywordflow}{return} -1;
47         \}
48 
49         idev = \hyperlink{mount_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\_task}->\hyperlink{structtask_afeeb6bafaefe505e6a730dd4e0be5a1a}{fd}[dfd];
50         \hyperlink{close_8c_a9d94cbe3ac3c59ac54d9e884a024d9c5}{sys\_close}(dfd);
51     \}
52 
53 
54     \textcolor{keywordtype}{int} sfd = \hyperlink{open_8c_ab7835c4352479c7a3d7af78c138e81c1}{sys\_open}(dir, O\_CREAT | \hyperlink{dirent_8h_a6afd3dd2f570069804b40e6aa24fc966}{O\_DIRECTORY} | O\_RDONLY, S\_IFDIR);
55     \textcolor{keywordflow}{if}(sfd < 0) \{
56         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
57         \textcolor{keywordflow}{return} -1;
58     \}
59 
60     idir = \hyperlink{mount_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\_task}->\hyperlink{structtask_afeeb6bafaefe505e6a730dd4e0be5a1a}{fd}[sfd];
61     \hyperlink{close_8c_a9d94cbe3ac3c59ac54d9e884a024d9c5}{sys\_close}(sfd);
62 
63     \hyperlink{structlist}{list\_t}* \hyperlink{aplus_8h_a2ffb5cf275c124e8f8ff30e1d4449f80}{fs} = \hyperlink{attribute_8h_ab96abe3fdf944e75a2316807105c1b6e}{attribute}(\textcolor{stringliteral}{"fs"});
64     \textcolor{keywordflow}{if}(\hyperlink{list_8h_a89e0fc8ca134e1dceb33c75b756e6754}{list\_empty}(fs)) \{
65         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENODEV;
66         \textcolor{keywordflow}{return} -1;
67     \}
68     
69 
70     \hyperlink{structfsys}{fsys\_t}* found = NULL;
71 
72     \hyperlink{list_8h_a1f44c976d2c698407a17fef984a5b232}{list\_foreach}(\hyperlink{attribute_8h_ae7f66047e6e39ba2bb6af8b95f00d1dd}{value}, fs) \{
73         \hyperlink{structfsys}{fsys\_t}* f = (\hyperlink{structfsys}{fsys\_t}*) \hyperlink{attribute_8h_ae7f66047e6e39ba2bb6af8b95f00d1dd}{value};
74 
75         \textcolor{keywordflow}{if}(strcmp(f->\hyperlink{structfsys_a8c3f03ed1ac90dac03da844178857891}{name}, fstype) == 0)
76             found = f;
77     \}
78 
79     \hyperlink{list_8h_a9c676c5a77ee9c18ccaadcb4f99fc990}{list\_destroy}(fs);
80 
81     \textcolor{keywordflow}{if}(found == NULL) \{
82         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENODEV;
83         \textcolor{keywordflow}{return} -1;
84     \}
85 
86     idir->\hyperlink{structinode_a4902d9f6a1d7bd79c6f1bb73d83ce8e3}{mode} |= S\_IFMT;
87     idir->\hyperlink{structinode_a127a2eb030df332fa64a81188731ad6b}{dev} = idev->\hyperlink{structinode_a1a77be0f24a6c9a18bbdbcecfb75df7c}{ino};
88 
89     \textcolor{keywordflow}{if}(found->\hyperlink{structfsys_ae6e5dcfb76d76f9636b95525ac63f4cb}{mount}(idev, idir, options) < 0) \{
90 
91         idir->\hyperlink{structinode_a4902d9f6a1d7bd79c6f1bb73d83ce8e3}{mode} &= ~S\_IFMT;
92         idir->\hyperlink{structinode_a127a2eb030df332fa64a81188731ad6b}{dev} = 0;       
93 
94         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENODEV;
95         \textcolor{keywordflow}{return} -1;
96     \}
97 
98     \textcolor{keywordflow}{return} 0;
99 \}
\end{DoxyCode}
\hypertarget{mount_8c_ad1f2426abc49e3a353545a7f6fd465eb}{\index{mount.\+c@{mount.\+c}!S\+Y\+S\+C\+A\+L\+L@{S\+Y\+S\+C\+A\+L\+L}}
\index{S\+Y\+S\+C\+A\+L\+L@{S\+Y\+S\+C\+A\+L\+L}!mount.\+c@{mount.\+c}}
\subsubsection[{S\+Y\+S\+C\+A\+L\+L}]{\setlength{\rightskip}{0pt plus 5cm}S\+Y\+S\+C\+A\+L\+L (
\begin{DoxyParamCaption}
\item[{{\bf sys\+\_\+mount}}]{, }
\item[{24}]{}
\end{DoxyParamCaption}
)}}\label{mount_8c_ad1f2426abc49e3a353545a7f6fd465eb}


\subsection{Variable Documentation}
\hypertarget{mount_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{\index{mount.\+c@{mount.\+c}!current\+\_\+task@{current\+\_\+task}}
\index{current\+\_\+task@{current\+\_\+task}!mount.\+c@{mount.\+c}}
\subsubsection[{current\+\_\+task}]{\setlength{\rightskip}{0pt plus 5cm}{\bf task\+\_\+t}$\ast$ current\+\_\+task}}\label{mount_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}


Current task address. 



Definition at line 35 of file sched.\+c.

