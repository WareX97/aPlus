\hypertarget{open_8c}{\section{Riferimenti per il file src/syscall/open.c}
\label{open_8c}\index{src/syscall/open.\+c@{src/syscall/open.\+c}}
}
{\ttfamily \#include $<$aplus.\+h$>$}\\*
{\ttfamily \#include $<$aplus/syscall.\+h$>$}\\*
{\ttfamily \#include $<$aplus/fs.\+h$>$}\\*
{\ttfamily \#include $<$aplus/task.\+h$>$}\\*
{\ttfamily \#include $<$unistd.\+h$>$}\\*
{\ttfamily \#include $<$fcntl.\+h$>$}\\*
{\ttfamily \#include $<$errno.\+h$>$}\\*
{\ttfamily \#include $<$sys/stat.\+h$>$}\\*
{\ttfamily \#include $<$dirent.\+h$>$}\\*
{\ttfamily \#include $<$stdio.\+h$>$}\\*
\subsection*{Funzioni}
\begin{DoxyCompactItemize}
\item 
static \hyperlink{fs_8h_a48b686d0c4375b0d1aab2296dc36c7a6}{inode\+\_\+t} $\ast$ \hyperlink{open_8c_a8b5a87d8a01e3e89bd9be45a8e177cb1}{ino\+\_\+open} (char $\ast$filename, int flags, mode\+\_\+t mode)
\item 
int \hyperlink{open_8c_ab7835c4352479c7a3d7af78c138e81c1}{sys\+\_\+open} (char $\ast$filename, int flags, mode\+\_\+t mode)
\item 
\hyperlink{open_8c_acad57ec13a2846f9bbbf7c99b66a773b}{S\+Y\+S\+C\+A\+L\+L} (\hyperlink{open_8c_ab7835c4352479c7a3d7af78c138e81c1}{sys\+\_\+open}, 10)
\end{DoxyCompactItemize}
\subsection*{Variabili}
\begin{DoxyCompactItemize}
\item 
\hyperlink{task_8h_a8aeef2cdb643462b97cd459a8e68cad3}{task\+\_\+t} $\ast$ \hyperlink{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\+\_\+task}
\item 
\hyperlink{fs_8h_a48b686d0c4375b0d1aab2296dc36c7a6}{inode\+\_\+t} $\ast$ \hyperlink{open_8c_a9af8258c3554800f6613f8147544225f}{vfs\+\_\+root}
\end{DoxyCompactItemize}


\subsection{Documentazione delle funzioni}
\hypertarget{open_8c_a8b5a87d8a01e3e89bd9be45a8e177cb1}{\index{open.\+c@{open.\+c}!ino\+\_\+open@{ino\+\_\+open}}
\index{ino\+\_\+open@{ino\+\_\+open}!open.\+c@{open.\+c}}
\subsubsection[{ino\+\_\+open}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf inode\+\_\+t}$\ast$ ino\+\_\+open (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{filename, }
\item[{int}]{flags, }
\item[{mode\+\_\+t}]{mode}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{open_8c_a8b5a87d8a01e3e89bd9be45a8e177cb1}


Definizione alla linea 19 del file open.\+c.



Referenzia task\+::cwd, errno, fs\+\_\+creat(), fs\+\_\+finddir(), kprintf, inode\+::link, inode\+::mode, O\+\_\+\+D\+I\+R\+E\+C\+T\+O\+R\+Y, O\+\_\+\+N\+O\+F\+O\+L\+L\+O\+W, e vfs\+\_\+root.


\begin{DoxyCode}
19                                                                  \{
20     \hyperlink{structinode}{inode\_t}* cwd = NULL;
21 
22     \textcolor{keywordflow}{if}(filename[0] == \textcolor{charliteral}{'/'})
23         cwd = \hyperlink{open_8c_a9af8258c3554800f6613f8147544225f}{vfs\_root};
24     \textcolor{keywordflow}{else}
25         cwd = \hyperlink{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\_task}->\hyperlink{structtask_a7099e7ba6a4c94559edfb4d396803b15}{cwd};
26     
27     \textcolor{keywordflow}{if}(!cwd) \{
28         \textcolor{keywordflow}{if}(!\hyperlink{open_8c_a9af8258c3554800f6613f8147544225f}{vfs\_root}) \{
29             \hyperlink{aplus_8h_af0b53ac0b8d6868da6396b11b30519c1}{kprintf}(\textcolor{stringliteral}{"sys\_open: no root found for cwd."});
30         
31             \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
32             \textcolor{keywordflow}{return} NULL;
33         \}
34         
35         cwd = \hyperlink{open_8c_a9af8258c3554800f6613f8147544225f}{vfs\_root};
36     \}
37     
38     
39     \textcolor{keywordflow}{if}(filename[0] == \textcolor{charliteral}{'/'})
40         filename++;
41         
42     \textcolor{keywordflow}{if}(filename[0] == 0)
43         \textcolor{keywordflow}{return} cwd;
44         
45     
46     \textcolor{keywordtype}{char}* s = filename;
47     \textcolor{keywordtype}{char}* p = s;
48     
49     \textcolor{keywordflow}{while}(*s) \{
50         \textcolor{keywordflow}{if}((p = strchr(s, \textcolor{charliteral}{'/'}))) \{
51             *p++ = 0;
52         
53             cwd = (\hyperlink{structinode}{inode\_t}*) \hyperlink{fs_8c_ad8edcff785980ccbc26c887c19ac8989}{fs\_finddir}(cwd, s);
54             \textcolor{keywordflow}{if}(!cwd) \{
55                 \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
56                 \textcolor{keywordflow}{return} NULL;
57             \}
58 
59             \textcolor{keywordflow}{while}(S\_ISLNK(cwd->\hyperlink{structinode_a4902d9f6a1d7bd79c6f1bb73d83ce8e3}{mode}))
60                 \textcolor{keywordflow}{if}(cwd->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link})
61                     cwd = cwd->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link};
62                 \textcolor{keywordflow}{else}
63                     \textcolor{keywordflow}{break};
64 
65 
66             \textcolor{keywordflow}{if}(!(S\_ISDIR(cwd->\hyperlink{structinode_a4902d9f6a1d7bd79c6f1bb73d83ce8e3}{mode}))) \{
67                 \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOTDIR;
68                 \textcolor{keywordflow}{return} NULL;
69             \}
70 
71             s = p;
72         \} \textcolor{keywordflow}{else}
73             \textcolor{keywordflow}{break};
74     \}
75 
76     \textcolor{keywordflow}{if}(*s == 0) \{
77         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
78         \textcolor{keywordflow}{return} NULL;
79     \}
80 
81     \hyperlink{structinode}{inode\_t}* ent = (\hyperlink{structinode}{inode\_t}*) \hyperlink{fs_8c_ad8edcff785980ccbc26c887c19ac8989}{fs\_finddir}(cwd, s);
82 
83     \textcolor{keywordflow}{if}(flags & O\_EXCL) \{
84         \textcolor{keywordflow}{if}(ent) \{
85             \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = EEXIST;
86             \textcolor{keywordflow}{return} NULL;
87         \}
88     \}
89 
90 
91     \textcolor{keywordflow}{if}(flags & O\_CREAT)
92         \textcolor{keywordflow}{if}(!ent)
93             ent = (\hyperlink{structinode}{inode\_t}*) \hyperlink{fs_8c_a8973117250569528548e2c2ff3f6e44e}{fs\_creat}(cwd, s, mode);
94         
95 
96     \textcolor{keywordflow}{if}(!ent) \{
97         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
98         \textcolor{keywordflow}{return} NULL;
99     \}
100 
101     \textcolor{keywordflow}{if}(!(flags & \hyperlink{dirent_8h_a82d4d551b214905742c9e045185d352a}{O\_NOFOLLOW})) \{
102         \textcolor{keywordflow}{while}(S\_ISLNK(ent->\hyperlink{structinode_a4902d9f6a1d7bd79c6f1bb73d83ce8e3}{mode})) \{
103             \textcolor{keywordflow}{if}(ent == ent->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link}) \{
104                 \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ELOOP;
105                 \textcolor{keywordflow}{return} NULL;
106             \}           
107 
108             \textcolor{keywordflow}{if}(ent->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link})
109                 ent = ent->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link};
110             \textcolor{keywordflow}{else}
111                 \textcolor{keywordflow}{break};
112         \}
113     \}
114 
115     \textcolor{keywordflow}{if}(flags & \hyperlink{dirent_8h_a6afd3dd2f570069804b40e6aa24fc966}{O\_DIRECTORY}) \{
116         \textcolor{keywordflow}{if}(!(S\_ISDIR(ent->\hyperlink{structinode_a4902d9f6a1d7bd79c6f1bb73d83ce8e3}{mode}))) \{
117             \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOTDIR;
118             \textcolor{keywordflow}{return} NULL;
119         \}
120     \}
121 
122 
123     \textcolor{keywordflow}{return} ent;
124 \}
\end{DoxyCode}
\hypertarget{open_8c_ab7835c4352479c7a3d7af78c138e81c1}{\index{open.\+c@{open.\+c}!sys\+\_\+open@{sys\+\_\+open}}
\index{sys\+\_\+open@{sys\+\_\+open}!open.\+c@{open.\+c}}
\subsubsection[{sys\+\_\+open}]{\setlength{\rightskip}{0pt plus 5cm}int sys\+\_\+open (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{filename, }
\item[{int}]{flags, }
\item[{mode\+\_\+t}]{mode}
\end{DoxyParamCaption}
)}}\label{open_8c_ab7835c4352479c7a3d7af78c138e81c1}


Definizione alla linea 126 del file open.\+c.



Referenzia errno, task\+::fd, ino\+\_\+open(), e T\+A\+S\+K\+\_\+\+M\+A\+X\+\_\+\+F\+D.


\begin{DoxyCode}
126                                                      \{
127     \textcolor{keywordflow}{if}(!\hyperlink{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\_task})
128         \textcolor{keywordflow}{return} -1;
129         
130     \hyperlink{structinode}{inode\_t}* ino = \hyperlink{open_8c_a8b5a87d8a01e3e89bd9be45a8e177cb1}{ino\_open}(filename, flags, mode);
131     \textcolor{keywordflow}{if}(!ino)
132         \textcolor{keywordflow}{return} -1;
133     
134     
135     \hyperlink{structinode}{inode\_t}** fd = NULL;
136     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < \hyperlink{task_8h_aa0beab24d02a2ccd5d273dea188af93d}{TASK\_MAX\_FD}; i++) \{
137         \textcolor{keywordflow}{if}(\hyperlink{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\_task}->\hyperlink{structtask_afeeb6bafaefe505e6a730dd4e0be5a1a}{fd}[i] == 0) \{
138             fd = &\hyperlink{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\_task}->\hyperlink{structtask_afeeb6bafaefe505e6a730dd4e0be5a1a}{fd}[i];
139             \textcolor{keywordflow}{break};
140         \}
141     \}
142     
143     \textcolor{keywordflow}{if}(fd == NULL) \{
144         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = EMFILE;
145         \textcolor{keywordflow}{return} -1;
146     \}
147     
148     *fd = ino;
149     \textcolor{keywordflow}{return} 0;
150 \}
\end{DoxyCode}
\hypertarget{open_8c_acad57ec13a2846f9bbbf7c99b66a773b}{\index{open.\+c@{open.\+c}!S\+Y\+S\+C\+A\+L\+L@{S\+Y\+S\+C\+A\+L\+L}}
\index{S\+Y\+S\+C\+A\+L\+L@{S\+Y\+S\+C\+A\+L\+L}!open.\+c@{open.\+c}}
\subsubsection[{S\+Y\+S\+C\+A\+L\+L}]{\setlength{\rightskip}{0pt plus 5cm}S\+Y\+S\+C\+A\+L\+L (
\begin{DoxyParamCaption}
\item[{{\bf sys\+\_\+open}}]{, }
\item[{10}]{}
\end{DoxyParamCaption}
)}}\label{open_8c_acad57ec13a2846f9bbbf7c99b66a773b}


\subsection{Documentazione delle variabili}
\hypertarget{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{\index{open.\+c@{open.\+c}!current\+\_\+task@{current\+\_\+task}}
\index{current\+\_\+task@{current\+\_\+task}!open.\+c@{open.\+c}}
\subsubsection[{current\+\_\+task}]{\setlength{\rightskip}{0pt plus 5cm}{\bf task\+\_\+t}$\ast$ current\+\_\+task}}\label{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}


Definizione alla linea 33 del file sched.\+c.

\hypertarget{open_8c_a9af8258c3554800f6613f8147544225f}{\index{open.\+c@{open.\+c}!vfs\+\_\+root@{vfs\+\_\+root}}
\index{vfs\+\_\+root@{vfs\+\_\+root}!open.\+c@{open.\+c}}
\subsubsection[{vfs\+\_\+root}]{\setlength{\rightskip}{0pt plus 5cm}{\bf inode\+\_\+t}$\ast$ vfs\+\_\+root}}\label{open_8c_a9af8258c3554800f6613f8147544225f}


Definizione alla linea 19 del file vfs.\+c.

