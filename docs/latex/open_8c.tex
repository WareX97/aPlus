\hypertarget{open_8c}{\section{src/syscall/open.c File Reference}
\label{open_8c}\index{src/syscall/open.\+c@{src/syscall/open.\+c}}
}
{\ttfamily \#include $<$aplus.\+h$>$}\\*
{\ttfamily \#include $<$aplus/syscall.\+h$>$}\\*
{\ttfamily \#include $<$aplus/fs.\+h$>$}\\*
{\ttfamily \#include $<$aplus/task.\+h$>$}\\*
{\ttfamily \#include $<$unistd.\+h$>$}\\*
{\ttfamily \#include $<$fcntl.\+h$>$}\\*
{\ttfamily \#include $<$errno.\+h$>$}\\*
{\ttfamily \#include $<$sys/stat.\+h$>$}\\*
{\ttfamily \#include $<$dirent.\+h$>$}\\*
{\ttfamily \#include $<$stdio.\+h$>$}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
static char $\ast$ \hyperlink{open_8c_a6fae53653306206ed481c3589c7aa51b}{dupstr} (char $\ast$s)
\item 
static \hyperlink{fs_8h_a48b686d0c4375b0d1aab2296dc36c7a6}{inode\+\_\+t} $\ast$ \hyperlink{open_8c_a8b5a87d8a01e3e89bd9be45a8e177cb1}{ino\+\_\+open} (char $\ast$filename, int \hyperlink{iso9660_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags}, mode\+\_\+t mode)
\item 
int \hyperlink{open_8c_ab7835c4352479c7a3d7af78c138e81c1}{sys\+\_\+open} (char $\ast$filename, int \hyperlink{iso9660_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags}, mode\+\_\+t mode)
\item 
\hyperlink{open_8c_acad57ec13a2846f9bbbf7c99b66a773b}{S\+Y\+S\+C\+A\+L\+L} (\hyperlink{open_8c_ab7835c4352479c7a3d7af78c138e81c1}{sys\+\_\+open}, 10)
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{task_8h_a8aeef2cdb643462b97cd459a8e68cad3}{task\+\_\+t} $\ast$ \hyperlink{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\+\_\+task}
\begin{DoxyCompactList}\small\item\em Current task address. \end{DoxyCompactList}\item 
\hyperlink{fs_8h_a48b686d0c4375b0d1aab2296dc36c7a6}{inode\+\_\+t} $\ast$ \hyperlink{open_8c_a9af8258c3554800f6613f8147544225f}{vfs\+\_\+root}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{open_8c_a6fae53653306206ed481c3589c7aa51b}{\index{open.\+c@{open.\+c}!dupstr@{dupstr}}
\index{dupstr@{dupstr}!open.\+c@{open.\+c}}
\subsubsection[{dupstr}]{\setlength{\rightskip}{0pt plus 5cm}static char$\ast$ dupstr (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{s}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{open_8c_a6fae53653306206ed481c3589c7aa51b}


Definition at line 19 of file open.\+c.



References kmalloc().


\begin{DoxyCode}
19                              \{
20     \textcolor{keywordtype}{char}* p = (\textcolor{keywordtype}{char}*) \hyperlink{mm_8h_a1f5d4240b2decc62c0e6eae06c72916c}{kmalloc}(strlen(s) + 1);
21     strcpy(p, s);
22 
23     \textcolor{keywordflow}{return} p;
24 \}
\end{DoxyCode}
\hypertarget{open_8c_a8b5a87d8a01e3e89bd9be45a8e177cb1}{\index{open.\+c@{open.\+c}!ino\+\_\+open@{ino\+\_\+open}}
\index{ino\+\_\+open@{ino\+\_\+open}!open.\+c@{open.\+c}}
\subsubsection[{ino\+\_\+open}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf inode\+\_\+t}$\ast$ ino\+\_\+open (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{filename, }
\item[{int}]{flags, }
\item[{mode\+\_\+t}]{mode}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{open_8c_a8b5a87d8a01e3e89bd9be45a8e177cb1}


Definition at line 27 of file open.\+c.



References task\+::cwd, errno, fs\+\_\+creat(), fs\+\_\+finddir(), kprintf(), inode\+::link, inode\+::mode, O\+\_\+\+D\+I\+R\+E\+C\+T\+O\+R\+Y, O\+\_\+\+N\+O\+F\+O\+L\+L\+O\+W, and vfs\+\_\+root.


\begin{DoxyCode}
27                                                                  \{
28     \hyperlink{structinode}{inode\_t}* cwd = NULL;
29 
30     \textcolor{keywordflow}{if}(filename[0] == \textcolor{charliteral}{'/'})
31         cwd = \hyperlink{open_8c_a9af8258c3554800f6613f8147544225f}{vfs\_root};
32     \textcolor{keywordflow}{else}
33         cwd = \hyperlink{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\_task}->\hyperlink{structtask_a7099e7ba6a4c94559edfb4d396803b15}{cwd};
34     
35     \textcolor{keywordflow}{if}(!cwd) \{
36         \textcolor{keywordflow}{if}(!\hyperlink{open_8c_a9af8258c3554800f6613f8147544225f}{vfs\_root}) \{
37             \hyperlink{debug_8c_ac9d768b4772cc87fc88afbbbd805f96a}{kprintf}(\textcolor{stringliteral}{"sys\_open: no root found for cwd."});
38         
39             \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
40             \textcolor{keywordflow}{return} NULL;
41         \}
42         
43         cwd = \hyperlink{open_8c_a9af8258c3554800f6613f8147544225f}{vfs\_root};
44     \}
45     
46     
47     \textcolor{keywordflow}{if}(filename[0] == \textcolor{charliteral}{'/'})
48         filename++;
49         
50     \textcolor{keywordflow}{if}(filename[0] == 0)
51         \textcolor{keywordflow}{return} cwd;
52         
53     
54     \textcolor{keywordtype}{char}* s = filename;
55     \textcolor{keywordtype}{char}* p = s;
56     
57     \textcolor{keywordflow}{while}(*s) \{
58         \textcolor{keywordflow}{if}((p = strchr(s, \textcolor{charliteral}{'/'}))) \{
59             *p++ = 0;
60         
61             cwd = (\hyperlink{structinode}{inode\_t}*) \hyperlink{fs_8c_ad8edcff785980ccbc26c887c19ac8989}{fs\_finddir}(cwd, s);
62             \textcolor{keywordflow}{if}(!cwd) \{
63                 \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
64                 \textcolor{keywordflow}{return} NULL;
65             \}
66 
67             \textcolor{keywordflow}{while}(S\_ISLNK(cwd->\hyperlink{structinode_a4902d9f6a1d7bd79c6f1bb73d83ce8e3}{mode}))
68                 \textcolor{keywordflow}{if}(cwd->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link})
69                     cwd = cwd->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link};
70                 \textcolor{keywordflow}{else}
71                     \textcolor{keywordflow}{break};
72 
73             s = p;
74         \} \textcolor{keywordflow}{else}
75             \textcolor{keywordflow}{break};
76     \}
77 
78     \textcolor{keywordflow}{if}(*s == 0) \{
79         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
80         \textcolor{keywordflow}{return} NULL;
81     \}
82 
83     \hyperlink{structinode}{inode\_t}* ent = (\hyperlink{structinode}{inode\_t}*) \hyperlink{fs_8c_ad8edcff785980ccbc26c887c19ac8989}{fs\_finddir}(cwd, s);
84 
85     \textcolor{keywordflow}{if}(\hyperlink{iso9660_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags} & O\_EXCL) \{
86         \textcolor{keywordflow}{if}(ent) \{
87             \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = EEXIST;
88             \textcolor{keywordflow}{return} NULL;
89         \}
90     \}
91 
92 
93     \textcolor{keywordflow}{if}(\hyperlink{iso9660_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags} & O\_CREAT)
94         \textcolor{keywordflow}{if}(!ent)
95             ent = (\hyperlink{structinode}{inode\_t}*) \hyperlink{fs_8c_a8973117250569528548e2c2ff3f6e44e}{fs\_creat}(cwd, s, mode);
96         
97 
98     \textcolor{keywordflow}{if}(!ent) \{
99         \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOENT;
100         \textcolor{keywordflow}{return} NULL;
101     \}
102 
103     \textcolor{keywordflow}{if}(!(\hyperlink{iso9660_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags} & \hyperlink{dirent_8h_a82d4d551b214905742c9e045185d352a}{O\_NOFOLLOW})) \{
104         \textcolor{keywordflow}{while}(S\_ISLNK(ent->\hyperlink{structinode_a4902d9f6a1d7bd79c6f1bb73d83ce8e3}{mode})) \{
105             \textcolor{keywordflow}{if}(ent == ent->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link}) \{
106                 \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ELOOP;
107                 \textcolor{keywordflow}{return} NULL;
108             \}           
109 
110             \textcolor{keywordflow}{if}(ent->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link})
111                 ent = ent->\hyperlink{structinode_a3533c53c5391601c66b3ae0f389c0843}{link};
112             \textcolor{keywordflow}{else}
113                 \textcolor{keywordflow}{break};
114         \}
115     \}
116 
117     \textcolor{keywordflow}{if}(\hyperlink{iso9660_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags} & \hyperlink{dirent_8h_a6afd3dd2f570069804b40e6aa24fc966}{O\_DIRECTORY}) \{
118         \textcolor{keywordflow}{if}(!(S\_ISDIR(ent->\hyperlink{structinode_a4902d9f6a1d7bd79c6f1bb73d83ce8e3}{mode}))) \{
119             \hyperlink{errno_8c_ad65a8842cc674e3ddf69355898c0ecbf}{errno} = ENOTDIR;
120             \textcolor{keywordflow}{return} NULL;
121         \}
122     \}
123 
124     \textcolor{keywordflow}{return} ent;
125 \}
\end{DoxyCode}
\hypertarget{open_8c_ab7835c4352479c7a3d7af78c138e81c1}{\index{open.\+c@{open.\+c}!sys\+\_\+open@{sys\+\_\+open}}
\index{sys\+\_\+open@{sys\+\_\+open}!open.\+c@{open.\+c}}
\subsubsection[{sys\+\_\+open}]{\setlength{\rightskip}{0pt plus 5cm}int sys\+\_\+open (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{filename, }
\item[{int}]{flags, }
\item[{mode\+\_\+t}]{mode}
\end{DoxyParamCaption}
)}}\label{open_8c_ab7835c4352479c7a3d7af78c138e81c1}


Definition at line 127 of file open.\+c.



References dupstr(), ino\+\_\+open(), kfree(), and schedule\+\_\+append\+\_\+fd().


\begin{DoxyCode}
127                                                      \{
128     \textcolor{keywordflow}{if}(!\hyperlink{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\_task})
129         \textcolor{keywordflow}{return} -1;
130 
131     \textcolor{keywordtype}{char}* p = \hyperlink{open_8c_a6fae53653306206ed481c3589c7aa51b}{dupstr}(filename);
132     \hyperlink{structinode}{inode\_t}* ino = \hyperlink{open_8c_a8b5a87d8a01e3e89bd9be45a8e177cb1}{ino\_open}(p, \hyperlink{iso9660_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags}, mode);
133     \hyperlink{mm_8h_acee1960bdb3a19cb495341ec725cafef}{kfree}(p);
134 
135     \textcolor{keywordflow}{if}(!ino)
136         \textcolor{keywordflow}{return} -1;
137     
138     
139     \textcolor{keywordflow}{return} \hyperlink{src_2sched_8c_afbffdc5298c98f92960a4fb9ba498063}{schedule\_append\_fd}(\hyperlink{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{current\_task}, ino);
140 \}
\end{DoxyCode}
\hypertarget{open_8c_acad57ec13a2846f9bbbf7c99b66a773b}{\index{open.\+c@{open.\+c}!S\+Y\+S\+C\+A\+L\+L@{S\+Y\+S\+C\+A\+L\+L}}
\index{S\+Y\+S\+C\+A\+L\+L@{S\+Y\+S\+C\+A\+L\+L}!open.\+c@{open.\+c}}
\subsubsection[{S\+Y\+S\+C\+A\+L\+L}]{\setlength{\rightskip}{0pt plus 5cm}S\+Y\+S\+C\+A\+L\+L (
\begin{DoxyParamCaption}
\item[{{\bf sys\+\_\+open}}]{, }
\item[{10}]{}
\end{DoxyParamCaption}
)}}\label{open_8c_acad57ec13a2846f9bbbf7c99b66a773b}


\subsection{Variable Documentation}
\hypertarget{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}{\index{open.\+c@{open.\+c}!current\+\_\+task@{current\+\_\+task}}
\index{current\+\_\+task@{current\+\_\+task}!open.\+c@{open.\+c}}
\subsubsection[{current\+\_\+task}]{\setlength{\rightskip}{0pt plus 5cm}{\bf task\+\_\+t}$\ast$ current\+\_\+task}}\label{open_8c_a4743b3673a8794b8e7bd0b6c91a63cd5}


Current task address. 



Definition at line 37 of file sched.\+c.

\hypertarget{open_8c_a9af8258c3554800f6613f8147544225f}{\index{open.\+c@{open.\+c}!vfs\+\_\+root@{vfs\+\_\+root}}
\index{vfs\+\_\+root@{vfs\+\_\+root}!open.\+c@{open.\+c}}
\subsubsection[{vfs\+\_\+root}]{\setlength{\rightskip}{0pt plus 5cm}{\bf inode\+\_\+t}$\ast$ vfs\+\_\+root}}\label{open_8c_a9af8258c3554800f6613f8147544225f}


Definition at line 19 of file vfs.\+c.

