\hypertarget{mm_8c}{\section{src/mm/mm.c File Reference}
\label{mm_8c}\index{src/mm/mm.\+c@{src/mm/mm.\+c}}
}
{\ttfamily \#include $<$sys/types.\+h$>$}\\*
{\ttfamily \#include $<$stddef.\+h$>$}\\*
{\ttfamily \#include $<$stdint.\+h$>$}\\*
{\ttfamily \#include $<$string.\+h$>$}\\*
{\ttfamily \#include $<$aplus/mm.\+h$>$}\\*
{\ttfamily \#include $<$aplus/list.\+h$>$}\\*
{\ttfamily \#include $<$grub.\+h$>$}\\*
\subsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structblock}{block}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structblock}{block} \hyperlink{mm_8c_a2cdc9850cc059eb848b6843d5327e37a}{\+\_\+\+\_\+attribute\+\_\+\+\_\+} ((packed))
\begin{DoxyCompactList}\small\item\em Alloc memory from Kernel Heap. \end{DoxyCompactList}\item 
void \hyperlink{mm_8c_a069f85a5001d71bc44d8be6532a4e432}{kfree} (void $\ast$ptr)
\begin{DoxyCompactList}\small\item\em Free memory from Kernel Heap. \end{DoxyCompactList}\item 
void $\ast$ \hyperlink{mm_8c_a0a2a93dff1df0b626cb5ff6d85d0553e}{krealloc} (void $\ast$ptr, size\+\_\+t \hyperlink{mm_8c_a854352f53b148adc24983a58a1866d66}{size})
\begin{DoxyCompactList}\small\item\em Realloc memory from Kernel Heap. \end{DoxyCompactList}\item 
void \hyperlink{mm_8c_a6f69e1474f69d9286294cfa23cdcc414}{mm\+\_\+setheap} (\hyperlink{mm_8h_ae3e9e8008e406505a3c57e4b7f17d300}{heap\+\_\+t} $\ast$\hyperlink{structheap}{heap})
\begin{DoxyCompactList}\small\item\em Set current heap for memory operations. \end{DoxyCompactList}\item 
volatile \hyperlink{mm_8h_ae3e9e8008e406505a3c57e4b7f17d300}{heap\+\_\+t} $\ast$ \hyperlink{mm_8c_a4e692b1c1f4e04a8b231f1493babb82f}{mm\+\_\+getheap} ()
\begin{DoxyCompactList}\small\item\em Get current heap for memory operations. \end{DoxyCompactList}\item 
int \hyperlink{mm_8c_a25db4b3982d49366c88b6be8331b9215}{mm\+\_\+init} ()
\begin{DoxyCompactList}\small\item\em Initialize M\+M\+U. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{aplus_8h_a53a0df51603c77c2aa5b9ea61b606a82}{uint32\+\_\+t} \hyperlink{mm_8c_a8ffb348d372acd38099f16b08bdaf4b5}{memsize}
\item 
volatile \hyperlink{mm_8h_ae3e9e8008e406505a3c57e4b7f17d300}{heap\+\_\+t} $\ast$ \hyperlink{mm_8c_a3068f9054a832aa72e12ab9ad210dd99}{current\+\_\+heap}
\item 
\hyperlink{aplus_8h_a53a0df51603c77c2aa5b9ea61b606a82}{uint32\+\_\+t} $\ast$ \hyperlink{mm_8c_a9bed7071511863f81c2de43b3c3f7db9}{current\+\_\+vmm}
\item 
\hyperlink{aplus_8h_a53a0df51603c77c2aa5b9ea61b606a82}{uint32\+\_\+t} $\ast$ \hyperlink{mm_8c_afac53891df03c313fc0b5b24e0acc8a9}{kernel\+\_\+vmm}
\item 
\hyperlink{list_8h_af629e6a6713d7de11eab50cbe6449b06}{list\+\_\+t} $\ast$ \hyperlink{mm_8c_a3744f58bc6d40534a3e026b2f242ab25}{vmm\+\_\+queue}
\item 
\hyperlink{aplus_8h_a5a8b2dc9e45a9ee81a94ef304fb62505}{uint16\+\_\+t} \hyperlink{mm_8c_a8c61e64b8675498cee79c59d3f8131e2}{magic}
\item 
size\+\_\+t \hyperlink{mm_8c_a854352f53b148adc24983a58a1866d66}{size}
\end{DoxyCompactItemize}


\subsection{Function Documentation}
\hypertarget{mm_8c_a2cdc9850cc059eb848b6843d5327e37a}{\index{mm.\+c@{mm.\+c}!\+\_\+\+\_\+attribute\+\_\+\+\_\+@{\+\_\+\+\_\+attribute\+\_\+\+\_\+}}
\index{\+\_\+\+\_\+attribute\+\_\+\+\_\+@{\+\_\+\+\_\+attribute\+\_\+\+\_\+}!mm.\+c@{mm.\+c}}
\subsubsection[{\+\_\+\+\_\+attribute\+\_\+\+\_\+}]{\setlength{\rightskip}{0pt plus 5cm}struct {\bf block} \+\_\+\+\_\+attribute\+\_\+\+\_\+ (
\begin{DoxyParamCaption}
\item[{(packed)}]{}
\end{DoxyParamCaption}
)}}\label{mm_8c_a2cdc9850cc059eb848b6843d5327e37a}


Alloc memory from Kernel Heap. 


\begin{DoxyParams}{Parameters}
{\em size} & Size of data to alloc. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Virtual Address of data. 
\end{DoxyReturn}


Definition at line 47 of file mm.\+c.


\begin{DoxyCode}
59                            \{
60     \textcolor{keywordtype}{void}* addr = (\textcolor{keywordtype}{void}*) \hyperlink{heap_8c_ace4a8a1fe937911a1a107c92e6d40339}{halloc}(\hyperlink{mm_8c_a3068f9054a832aa72e12ab9ad210dd99}{current\_heap}, \hyperlink{mm_8c_a854352f53b148adc24983a58a1866d66}{size});
61     \textcolor{keywordflow}{if}(!addr)
62         \hyperlink{panic_8c_a92ad17d19a46880dd5e6c99143666b4a}{panic}(\textcolor{stringliteral}{"halloc(): failed!"});
63 
64 
65     addr = \hyperlink{mm_8h_a5e7e52cb995fbefca3ca2a7bab8556e6}{mm\_vaddr}(addr);
66 
67     block\_t* \hyperlink{structblock}{block} = (block\_t*) addr;
68     block->\hyperlink{structblock_a0dc8afecb033f59b42e0d8502a7f8ff0}{magic} = \hyperlink{mm_8h_a24ee1b93dcb4a2d30a151491245967ec}{BLKMAGIC};
69     block->size = \hyperlink{mm_8c_a854352f53b148adc24983a58a1866d66}{size};
70 
71     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{void}*) ((\hyperlink{aplus_8h_a53a0df51603c77c2aa5b9ea61b606a82}{uint32\_t}) block + \textcolor{keyword}{sizeof}(block\_t));
72 \}
\end{DoxyCode}
\hypertarget{mm_8c_a069f85a5001d71bc44d8be6532a4e432}{\index{mm.\+c@{mm.\+c}!kfree@{kfree}}
\index{kfree@{kfree}!mm.\+c@{mm.\+c}}
\subsubsection[{kfree}]{\setlength{\rightskip}{0pt plus 5cm}void kfree (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{ptr}
\end{DoxyParamCaption}
)}}\label{mm_8c_a069f85a5001d71bc44d8be6532a4e432}


Free memory from Kernel Heap. 


\begin{DoxyParams}{Parameters}
{\em ptr} & Pointer to data allocated. \\
\hline
\end{DoxyParams}


Definition at line 79 of file mm.\+c.



References B\+L\+K\+M\+A\+G\+I\+C, hfree(), mm\+\_\+align(), mm\+\_\+paddr(), and size.


\begin{DoxyCode}
79                       \{
80     \textcolor{keywordflow}{if}(!ptr)
81         \textcolor{keywordflow}{return};
82         
83     
84     block\_t* \hyperlink{structblock}{block} = (block\_t*) ptr;
85     \textcolor{keywordflow}{if}(block->magic != \hyperlink{mm_8h_a24ee1b93dcb4a2d30a151491245967ec}{BLKMAGIC})
86         \textcolor{keywordflow}{return};
87         
88     \textcolor{keywordtype}{size\_t} \hyperlink{mm_8c_a854352f53b148adc24983a58a1866d66}{size} = block->size;
89     block->size = 0;
90     block->magic = 0;
91     
92     
93     \hyperlink{heap_8c_ad3d08e75d8a9f8e12e405536dccdd851}{hfree}(\hyperlink{mm_8c_a3068f9054a832aa72e12ab9ad210dd99}{current\_heap}, \hyperlink{mm_8h_a3fbcc6a4fcc3452357e636f90b925554}{mm\_paddr}(\hyperlink{mm_8h_acb964323e95c799eb3896dce8c61d329}{mm\_align}(ptr)), size);
94 \}
\end{DoxyCode}
\hypertarget{mm_8c_a0a2a93dff1df0b626cb5ff6d85d0553e}{\index{mm.\+c@{mm.\+c}!krealloc@{krealloc}}
\index{krealloc@{krealloc}!mm.\+c@{mm.\+c}}
\subsubsection[{krealloc}]{\setlength{\rightskip}{0pt plus 5cm}void$\ast$ krealloc (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{ptr, }
\item[{size\+\_\+t}]{size}
\end{DoxyParamCaption}
)}}\label{mm_8c_a0a2a93dff1df0b626cb5ff6d85d0553e}


Realloc memory from Kernel Heap. 


\begin{DoxyParams}{Parameters}
{\em ptr} & Pointer to data allocated. \\
\hline
{\em size} & Size of data to alloc. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Virtual Address of data. 
\end{DoxyReturn}


Definition at line 103 of file mm.\+c.



References B\+L\+K\+M\+A\+G\+I\+C, kfree(), and kmalloc().


\begin{DoxyCode}
103                                        \{
104     \textcolor{keywordflow}{if}(ptr == NULL)
105         \textcolor{keywordflow}{return} \hyperlink{mm_8h_a1f5d4240b2decc62c0e6eae06c72916c}{kmalloc}(\hyperlink{mm_8c_a854352f53b148adc24983a58a1866d66}{size});
106         
107     \textcolor{keywordflow}{if}(\hyperlink{mm_8c_a854352f53b148adc24983a58a1866d66}{size} == 0) \{
108         \hyperlink{mm_8c_a069f85a5001d71bc44d8be6532a4e432}{kfree}(ptr);
109         \textcolor{keywordflow}{return} NULL;
110     \}   
111 
112     block\_t* \hyperlink{structblock}{block} = (block\_t*) ptr;
113     \textcolor{keywordflow}{if}(block->magic != \hyperlink{mm_8h_a24ee1b93dcb4a2d30a151491245967ec}{BLKMAGIC})
114         \textcolor{keywordflow}{return} NULL;
115         
116     \textcolor{keywordtype}{void}* newptr = \hyperlink{mm_8h_a1f5d4240b2decc62c0e6eae06c72916c}{kmalloc}(\hyperlink{mm_8c_a854352f53b148adc24983a58a1866d66}{size});
117     \textcolor{keywordflow}{if}(!newptr)
118         \textcolor{keywordflow}{return} NULL;
119         
120     \textcolor{keywordflow}{if}(\hyperlink{mm_8c_a854352f53b148adc24983a58a1866d66}{size} > block->size)
121         \hyperlink{mm_8c_a854352f53b148adc24983a58a1866d66}{size} = block->size;
122         
123     memcpy(newptr, ptr, \hyperlink{mm_8c_a854352f53b148adc24983a58a1866d66}{size});
124     \hyperlink{mm_8c_a069f85a5001d71bc44d8be6532a4e432}{kfree}(ptr);
125     
126     \textcolor{keywordflow}{return} newptr;
127 \}
\end{DoxyCode}
\hypertarget{mm_8c_a4e692b1c1f4e04a8b231f1493babb82f}{\index{mm.\+c@{mm.\+c}!mm\+\_\+getheap@{mm\+\_\+getheap}}
\index{mm\+\_\+getheap@{mm\+\_\+getheap}!mm.\+c@{mm.\+c}}
\subsubsection[{mm\+\_\+getheap}]{\setlength{\rightskip}{0pt plus 5cm}volatile {\bf heap\+\_\+t}$\ast$ mm\+\_\+getheap (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{mm_8c_a4e692b1c1f4e04a8b231f1493babb82f}


Get current heap for memory operations. 



Definition at line 141 of file mm.\+c.



References current\+\_\+heap.


\begin{DoxyCode}
141                               \{
142     \textcolor{keywordflow}{return} \hyperlink{mm_8c_a3068f9054a832aa72e12ab9ad210dd99}{current\_heap};
143 \}
\end{DoxyCode}
\hypertarget{mm_8c_a25db4b3982d49366c88b6be8331b9215}{\index{mm.\+c@{mm.\+c}!mm\+\_\+init@{mm\+\_\+init}}
\index{mm\+\_\+init@{mm\+\_\+init}!mm.\+c@{mm.\+c}}
\subsubsection[{mm\+\_\+init}]{\setlength{\rightskip}{0pt plus 5cm}int mm\+\_\+init (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{mm_8c_a25db4b3982d49366c88b6be8331b9215}


Initialize M\+M\+U. 



Definition at line 149 of file mm.\+c.



References kheap\+\_\+init(), mbd, Boot\+Info\+\_\+t\+::mem\+\_\+lower, Boot\+Info\+\_\+t\+::mem\+\_\+upper, memsize, vmm\+\_\+init(), and V\+M\+M\+\_\+\+M\+A\+X\+\_\+\+M\+E\+M\+O\+R\+Y.


\begin{DoxyCode}
149               \{
150 
151     \hyperlink{mm_8c_a8ffb348d372acd38099f16b08bdaf4b5}{memsize} = (\hyperlink{grub_8h_abac514a5a8c938a1de6fb08f542f5962}{mbd}->\hyperlink{structBootInfo__t_ab20281f521d626a49714e06b62291be9}{mem\_upper} + \hyperlink{grub_8h_abac514a5a8c938a1de6fb08f542f5962}{mbd}->\hyperlink{structBootInfo__t_a4b144c9db5fe2c5a9d72522068d65138}{mem\_lower}) * 1024;
152     \textcolor{keywordflow}{if}(\hyperlink{mm_8c_a8ffb348d372acd38099f16b08bdaf4b5}{memsize} > \hyperlink{mm_8h_a17f8a27ab3548000488ca27d70785240}{VMM\_MAX\_MEMORY})
153         \hyperlink{mm_8c_a8ffb348d372acd38099f16b08bdaf4b5}{memsize} = \hyperlink{mm_8h_a17f8a27ab3548000488ca27d70785240}{VMM\_MAX\_MEMORY};
154 
155 
156     \hyperlink{kheap_8c_ab761c0c9768623b035f3fd5c98f77b08}{kheap\_init}();
157     \hyperlink{paging_8c_aac183f585641487a954ca46c0d7bde31}{vmm\_init}();
158 
159     \textcolor{keywordflow}{return} 0;
160 \}
\end{DoxyCode}
\hypertarget{mm_8c_a6f69e1474f69d9286294cfa23cdcc414}{\index{mm.\+c@{mm.\+c}!mm\+\_\+setheap@{mm\+\_\+setheap}}
\index{mm\+\_\+setheap@{mm\+\_\+setheap}!mm.\+c@{mm.\+c}}
\subsubsection[{mm\+\_\+setheap}]{\setlength{\rightskip}{0pt plus 5cm}void mm\+\_\+setheap (
\begin{DoxyParamCaption}
\item[{{\bf heap\+\_\+t} $\ast$}]{heap}
\end{DoxyParamCaption}
)}}\label{mm_8c_a6f69e1474f69d9286294cfa23cdcc414}


Set current heap for memory operations. 



Definition at line 134 of file mm.\+c.


\begin{DoxyCode}
134                               \{
135     \hyperlink{mm_8c_a3068f9054a832aa72e12ab9ad210dd99}{current\_heap} = heap;
136 \}
\end{DoxyCode}


\subsection{Variable Documentation}
\hypertarget{mm_8c_a3068f9054a832aa72e12ab9ad210dd99}{\index{mm.\+c@{mm.\+c}!current\+\_\+heap@{current\+\_\+heap}}
\index{current\+\_\+heap@{current\+\_\+heap}!mm.\+c@{mm.\+c}}
\subsubsection[{current\+\_\+heap}]{\setlength{\rightskip}{0pt plus 5cm}volatile {\bf heap\+\_\+t}$\ast$ current\+\_\+heap}}\label{mm_8c_a3068f9054a832aa72e12ab9ad210dd99}


Definition at line 36 of file mm.\+c.

\hypertarget{mm_8c_a9bed7071511863f81c2de43b3c3f7db9}{\index{mm.\+c@{mm.\+c}!current\+\_\+vmm@{current\+\_\+vmm}}
\index{current\+\_\+vmm@{current\+\_\+vmm}!mm.\+c@{mm.\+c}}
\subsubsection[{current\+\_\+vmm}]{\setlength{\rightskip}{0pt plus 5cm}{\bf uint32\+\_\+t}$\ast$ current\+\_\+vmm}}\label{mm_8c_a9bed7071511863f81c2de43b3c3f7db9}


Definition at line 46 of file paging.\+c.

\hypertarget{mm_8c_afac53891df03c313fc0b5b24e0acc8a9}{\index{mm.\+c@{mm.\+c}!kernel\+\_\+vmm@{kernel\+\_\+vmm}}
\index{kernel\+\_\+vmm@{kernel\+\_\+vmm}!mm.\+c@{mm.\+c}}
\subsubsection[{kernel\+\_\+vmm}]{\setlength{\rightskip}{0pt plus 5cm}{\bf uint32\+\_\+t}$\ast$ kernel\+\_\+vmm}}\label{mm_8c_afac53891df03c313fc0b5b24e0acc8a9}


Definition at line 47 of file paging.\+c.

\hypertarget{mm_8c_a8c61e64b8675498cee79c59d3f8131e2}{\index{mm.\+c@{mm.\+c}!magic@{magic}}
\index{magic@{magic}!mm.\+c@{mm.\+c}}
\subsubsection[{magic}]{\setlength{\rightskip}{0pt plus 5cm}{\bf uint16\+\_\+t} magic}}\label{mm_8c_a8c61e64b8675498cee79c59d3f8131e2}


Definition at line 42 of file mm.\+c.

\hypertarget{mm_8c_a8ffb348d372acd38099f16b08bdaf4b5}{\index{mm.\+c@{mm.\+c}!memsize@{memsize}}
\index{memsize@{memsize}!mm.\+c@{mm.\+c}}
\subsubsection[{memsize}]{\setlength{\rightskip}{0pt plus 5cm}{\bf uint32\+\_\+t} memsize}}\label{mm_8c_a8ffb348d372acd38099f16b08bdaf4b5}


Definition at line 35 of file mm.\+c.

\hypertarget{mm_8c_a854352f53b148adc24983a58a1866d66}{\index{mm.\+c@{mm.\+c}!size@{size}}
\index{size@{size}!mm.\+c@{mm.\+c}}
\subsubsection[{size}]{\setlength{\rightskip}{0pt plus 5cm}size\+\_\+t size}}\label{mm_8c_a854352f53b148adc24983a58a1866d66}


Definition at line 43 of file mm.\+c.

\hypertarget{mm_8c_a3744f58bc6d40534a3e026b2f242ab25}{\index{mm.\+c@{mm.\+c}!vmm\+\_\+queue@{vmm\+\_\+queue}}
\index{vmm\+\_\+queue@{vmm\+\_\+queue}!mm.\+c@{mm.\+c}}
\subsubsection[{vmm\+\_\+queue}]{\setlength{\rightskip}{0pt plus 5cm}{\bf list\+\_\+t}$\ast$ vmm\+\_\+queue}}\label{mm_8c_a3744f58bc6d40534a3e026b2f242ab25}


Definition at line 49 of file paging.\+c.

